name: Approval Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main, dev]

jobs:
  # Fast build verification (seconds)
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/determinate-nix-action@v3

      - name: Verify configuration builds
        run: |
          nix build ./nixos_system_config#checks.x86_64-linux.SYSTEM_INSTALLS_FROM_ONE_SCRIPT -L

  # Property tests (minutes) - boot the system and verify properties
  property-tests:
    runs-on: ubuntu-latest
    needs: build  # Only run if build succeeds
    strategy:
      matrix:
        test:
          - SERVICES_ARE_RUNNING
          - IMPERMANENCE_WORKS
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/determinate-nix-action@v3

      - name: Run ${{ matrix.test }}
        run: |
          nix build ./nixos_system_config#checks.x86_64-linux.${{ matrix.test }} -L
