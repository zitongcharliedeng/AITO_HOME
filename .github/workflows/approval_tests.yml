name: Approval Tests

on:
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            system-features = nixos-test benchmark big-parallel kvm

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Run tests and collect screenshots
        run: nix build ./nixos_system_config#ALL_SCREENSHOTS -L

      - name: Update goldens
        run: |
          for test_dir in result/*/; do
            test_name=$(basename "$test_dir")
            cp "$test_dir"*.png "nixos_system_config/approval_tests/$test_name/goldens/"
          done

      - name: Commit screenshots
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add nixos_system_config/approval_tests/*/goldens/*.png
          git diff --staged --quiet || git commit -m "Update golden screenshots"
          git push
