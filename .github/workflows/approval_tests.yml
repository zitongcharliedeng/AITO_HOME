name: Approval Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main, dev]

jobs:
  no-comments-in-nix-files:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Verify no comments in nix files
        run: |
          if grep -rn '^\s*#' --include='*.nix' nixos_system_config/ | grep -v '#!'; then
            echo "ERROR: Comments found in nix files"
            echo "Comments are prohibited - use verbose naming and refactoring instead"
            exit 1
          fi

  build:
    runs-on: ubuntu-latest
    needs: no-comments-in-nix-files
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/determinate-nix-action@v3
      - name: Verify configuration builds
        run: nix build ./nixos_system_config#checks.x86_64-linux.SYSTEM_INSTALLS_FROM_ONE_SCRIPT -L

  property-tests:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        test:
          - SERVICES_ARE_RUNNING
          - IMPERMANENCE_WORKS
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/determinate-nix-action@v3
      - name: Run ${{ matrix.test }}
        run: nix build ./nixos_system_config#checks.x86_64-linux.${{ matrix.test }} -L
